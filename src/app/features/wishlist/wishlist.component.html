<!--wishlist-component.html-->

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading your wishlists...</span>
  </div>
</div>

<!-- Empty State -->
<div class="wishlist-container" *ngIf="state === 'empty' && !loading">
  <div class="page-header">
    <h1>My Wishlists</h1>
  </div>
  
  <div class="empty-state">
    <div class="empty-icon">
      <img src="https://efreshli.com/_next/static/media/empty-wishlists-list.75fb27a1.png" alt="empty wishlist">
    </div>
    <h2>All Your Lists, All in One Place</h2>
    <p>Start saving your favorite items, shops, and ideas to a list that fits your lifestyle.</p>
    <button class="primary-btn" (click)="openCreatePopup()">Create Your First List</button>
  </div>
</div>

<!-- Wishlists List View -->
<div class="wishlist-container" *ngIf="state === 'list' && !loading">
  
  <div class="start-sec">
    <p>Wishlists</p>
    <button class="list-btn" (click)="openCreatePopup()">Create a list</button>
</div>
<hr>
  <div class="wishlists-grid">
    <div class="wishlist-card" 
         *ngFor="let list of wishlistsSummary" 
         (click)="navigateToWishlist(list)">
      
      <!-- Card Header -->
      <div class="card-header">
        <div class="header-left">
          <div class="wishlist-icon">
            <svg data-name="Group 79934" xmlns="http://www.w3.org/2000/svg" width="49.896" height="28.217" viewBox="0 0 49.896 28.217">
              <g data-name="Group 79933">
                <path data-name="Path 35479" d="M479.373 128.755a6.172 6.172 0 0 1 .454-.955 6.5 6.5 0 0 1 .409.968c.225-.161.449-.32.68-.474.32.334.038.695-.164 1a1.734 1.734 0 0 1 .949.435 9.144 9.144 0 0 1-.955.27c.137.269.6.851.109.945a5.18 5.18 0 0 1-.705-.438 45.959 45.959 0 0 0 .362 5.212c.653-.659.648-1.612.954-2.431-.249-.074-.5-.151-.746-.227l.127-.393c.224-.055.451-.108.676-.161-.121-.214-.247-.427-.366-.641l.224-.323c.262.154.523.308.784.465.035-.292.071-.583.115-.874l.413.017.141.843q.4-.246.807-.478c.032.092.1.273.131.365l-.388.619c.272.076.545.153.819.234.025.071.077.215.1.286q-.445.144-.891.272a3.361 3.361 0 0 1 .346.929 8.957 8.957 0 0 1-.941-.361l-.106.631-.8-.023a16.539 16.539 0 0 0-1.061 2.444c1.031.064 2.063.015 3.1.031a3.848 3.848 0 0 1-.14 1.593c-.176.473-.5.874-.678 1.343.159.4.468.768.316 1.224h-6.346a1.452 1.452 0 0 1 .41-1.165 7.1 7.1 0 0 1-.771-1.563 6.426 6.426 0 0 1-.067-1.348c.939-.032 1.883.028 2.821-.061a8.918 8.918 0 0 0-.744-1.377c-.174-.275-.532-.276-.813-.361a45.556 45.556 0 0 1-.275-.538c-.3.079-.59.156-.888.22a1.469 1.469 0 0 1 .372-.951l-.755-.141c0-.161.007-.323.012-.483l.632-.131c-.169-.314-.363-.663-.144-1 .3.156.59.327.878.506.077-.34.06-.787.448-.939.1.308.186.619.273.932.218-.147.433-.3.654-.443.1.1.195.206.3.308-.153.247-.307.493-.456.74l.646-.028a22.346 22.346 0 0 0-.166-2.681c-.279.218-.6.557-.971.324.118-.313.25-.618.388-.922a1.624 1.624 0 0 1-.9-.413c.3-.106.6-.2.907-.288-.161-.24-.318-.481-.475-.723.126-.077.254-.153.384-.23.193.134.388.269.58.406m-.331 5.092a3.328 3.328 0 0 1 .3 1.258 1.469 1.469 0 0 0 .522.936 8.379 8.379 0 0 0-.15-2.034l-.67-.16m-1.362 4.116a2.8 2.8 0 0 0 .75 1.441 2.714 2.714 0 0 0 3.18.409 2.8 2.8 0 0 0 1.361-1.842 71.56 71.56 0 0 0-5.302-.005z" transform="translate(-469.11 -127.8)" style="fill: rgb(68, 68, 68);"></path>
                <g data-name="Group 79931">
                  <path data-name="Path 35481" d="M802.366 163.16a1.833 1.833 0 0 1 1.585-1.63c.678-.074 1.359-.023 2.04-.031 4.41 0 8.821.007 13.231-.006a2.422 2.422 0 0 1 1.492.336 2.226 2.226 0 0 1 .76 1.614c.038 1.069-.047 2.139.029 3.207a2.512 2.512 0 0 1 1.58.506 1.959 1.959 0 0 1 .595 1.525c.006 2.521-.016 5.045.007 7.568 0 .4-.031 8.143-.07 8.537l-.76-.009c-.049-.567-.067-8.489-.068-9.058-1.915-.071-3.833.044-5.746-.079-1.892-.076-3.782.1-5.67-.006-2.133 0-4.266-.041-6.4.064-1.326.076-2.656-.169-3.976.032 0 .566-.009 8.485-.042 9.049-.234.01-.468.019-.7.026-.1-2.726 0-12.81-.048-15.536a3.123 3.123 0 0 1 .347-1.957c.406-.534 1.13-.595 1.729-.772.1-1.125-.048-2.259.083-3.382m.823.441q-.015 4.094 0 8.19c1.612.058 3.225 0 4.837.022 4.184-.01 8.369.029 12.552-.017.035-2.735 0-5.47.016-8.2a1.08 1.08 0 0 0-1.083-1.211H804.39a1.143 1.143 0 0 0-1.2 1.223m18.543 3.84-.24.151a86.937 86.937 0 0 0 0 4.211c.429.013.859.019 1.29.02.026-.952.019-1.9.023-2.855a1.6 1.6 0 0 0-.225-1.026 2.612 2.612 0 0 0-.851-.5m-20.618 1.1c-.058 1.048-.028 2.1 0 3.149h1.165c.045-1.05.017-2.1.031-3.148-.031-.324.067-.733-.243-.949a.964.964 0 0 0-.957.951m-.106 4.171a26.67 26.67 0 0 0-.006 2c3.406.064 6.815.007 10.222.028 3.854-.009 7.709.013 11.563-.009.029-.678.029-1.357-.009-2.034-7.25-.006-14.507-.044-21.764.004z" transform="translate(-773.789 -156.59)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35484" d="M843.93 186.267c.358.022.932-.17 1.032.321a.6.6 0 0 1-.855.708c-.419-.187-.231-.69-.177-1.029z" transform="translate(-811.081 -177.75)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35485" d="M876.832 186.309a4.131 4.131 0 0 1 .848 0l.039.917c-.333.11-.779.288-1.035-.064a.547.547 0 0 1 .148-.853z" transform="translate(-839.016 -177.782)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35486" d="M909.854 186.264c.358.013.89-.169 1.085.25.321.5-.455 1.15-.9.763a.811.811 0 0 1-.185-1.013z" transform="translate(-867.419 -177.74)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35488" d="M876.786 205.791a.569.569 0 0 1 1.009-.006 3.72 3.72 0 0 1 .015.853l-.907.058c-.12-.282-.379-.617-.117-.905z" transform="translate(-839.139 -194.187)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35491" d="M844.038 205.871c.372-.205.884.25.769.659-.015.621-1.08.611-1.153.028a.569.569 0 0 1 .384-.687z" transform="translate(-810.907 -194.477)" style="fill: rgb(68, 68, 68);"></path>
                  <path data-name="Path 35492" d="M910.28 205.99c.368-.536 1.358.144.992.682-.173.384-.653.24-.984.3-.066-.314-.257-.707-.008-.982z" transform="translate(-867.754 -194.455)" style="fill: rgb(68, 68, 68);"></path>
                </g>
                <path data-name="Path 35493" d="M426.333 222.5h22.309c.143 1.182.044 2.376.068 3.562-.025 1.176.071 9.709-.06 10.881-.3-.022-.6-.057-.906-.1-.025-1.016.028-9.388-.033-10.4-4.238-.058-8.478-.007-12.717-.025-2.584.022-5.169-.045-7.749.029-.058 1.021 0 9.4-.035 10.419-.294.022-.584.051-.877.073-.017-2.358-.026-12.072 0-14.43m.912 1.019a14.72 14.72 0 0 0 0 1.878c2.437.084 4.878.01 7.316.035 4.385-.017 8.771.035 13.156-.025a13.46 13.46 0 0 0 0-1.892c-4.141-.07-8.284-.01-12.427-.028-2.69.017-5.367-.047-8.045.028z" transform="translate(-426.316 -208.731)" style="fill: rgb(68, 68, 68);"></path>
              </g>
            </svg>
          </div>
          <div class="wishlist-info">
          <span class="wishlist-title">{{ list.wishlistName }}</span>
          <span class="item-count">{{ list.itemsCount }} {{ list.itemsCount === 1 ? 'item' : 'items' }}</span>
        </div>
        </div>
        
        <button class="share-btn" [disabled]="list.itemsCount === 0"
      [class.disabled]="list.itemsCount === 0"
      (click)="list.itemsCount > 0 ? shareWishlist(list, $event) : null">
          <svg xmlns="http://www.w3.org/2000/svg" width="18.25" height="15.969" viewBox="0 0 18.25 15.969">
            <path data-name="Icon open-share" d="M11.406 0v4.562C2.281 4.562 0 9.239 0 15.968c1.186-4.517 4.562-6.844 9.125-6.844h2.281v4.562l6.844-7.209z" style="fill: rgb(30, 136, 229);"></path>
          </svg>
          Share to
        </button>
      </div>
      
      <!-- Card Content -->
      <div class="card-content">
        <!-- Empty Wishlist State -->
        <div class="empty-preview" *ngIf="list.itemsCount === 0">
          <div class="empty-preview-icon">
            <img src="https://efreshli.com/images/wishlists/empty-wishlist-card.png" alt="">
          </div>
          <p class="empty-text">Your wishlist is empty</p>
        </div>
        
        <!-- Wishlist with Items -->
        <div class="preview-content" *ngIf="list.itemsCount > 0">
          <!-- Main Image -->
          <div class="main-preview">
            <img [src]="list.mainImages?.[0] || 'assets/placeholder.jpg'" 
                 alt="Main item"
                 class="main-image">
          </div>
          
          <!-- Grid Images -->
          <div class="grid-preview">
            <div class="grid-item" 
                 *ngFor="let image of list.mainImages?.slice(1, 4); let i = index">
              <img [src]="image" 
                   alt="Item preview"
                   class="grid-image">
              
              <!-- More Items Overlay -->
              <div class="more-items-overlay" 
                   *ngIf="i === 2 && list.mainImages && list.mainImages.length > 4">
                <span class="more-count">+{{ list.mainImages.length - 4 }}</span>
              </div>
            </div>
            
            <!-- Fill empty grid slots -->
            <div class="grid-item empty-slot" 
                 *ngFor="let slot of getEmptySlots(list.mainImages?.length || 0)">
              <div class="empty-slot-content">
                <i class="far fa-image"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Wishlist Detail View -->
<div class="wishlist-detail" *ngIf="state === 'detail' && selectedList && !loading">
  <span class="arrow">&lt;</span> <a class="back-link" (click)="backToLists()">Back to My Lists</a>
  
  <div class="head">
    <h1>{{ selectedList.wishlistName }}</h1>
    
    <!-- Edit Name Form -->
    
    <div class="list-actions">
      <button class="action-btn edit-btn" (click)="startEditName()">
        <svg data-name="Component 13 – 39" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
          <g data-name="Icon feather-edit">
            <path data-name="Path 35495" d="M9.235 6H4.386A1.386 1.386 0 0 0 3 7.386v9.7a1.386 1.386 0 0 0 1.386 1.384h9.7a1.386 1.386 0 0 0 1.386-1.386v-4.849" transform="translate(5 3.47)" style="fill: none; stroke: rgb(153, 153, 153); stroke-linecap: round; stroke-linejoin: round; stroke-width: 0.8px;"></path>
            <path data-name="Path 35496" d="M19.274 3.248a1.47 1.47 0 1 1 2.078 2.078l-6.581 6.581L12 12.6l.693-2.771z" transform="translate(.157 5.182)" style="fill: none; stroke: rgb(153, 153, 153); stroke-linecap: round; stroke-linejoin: round; stroke-width: 0.8px;"></path>
          </g>
        </svg>
      </button>
      <button  class="action-btn delete-btn" (click)="confirmDeleteWishlist()">
          <svg data-name="Component 14 – 39" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
            <path data-name="Path 11539" d="M19.581 27.192h-7.6a.613.613 0 0 1-.607-.559l-.868-10.367a.2.2 0 0 1 .2-.216h10.153a.2.2 0 0 1 .2.216l-.869 10.368a.613.613 0 0 1-.609.558zM10.92 16.449l.85 10.151a.212.212 0 0 0 .21.194h7.6a.212.212 0 0 0 .21-.194l.85-10.151z" transform="translate(-.54 -5.253)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
            <path data-name="Path 11540" d="M17.711 10.552H6.093a.432.432 0 0 1-.432-.432v-1a.432.432 0 0 1 .432-.432h11.618a.432.432 0 0 1 .432.432v1a.432.432 0 0 1-.432.431zM6.093 9.083a.033.033 0 0 0-.033.033v1a.033.033 0 0 0 .033.033h11.618a.033.033 0 0 0 .033-.033v-1a.033.033 0 0 0-.033-.033z" transform="translate(3.339 .646)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
            <path data-name="Path 11541" d="M30.9 3.729h-3.51a.2.2 0 0 1-.2-.2V2.521A.522.522 0 0 1 27.709 2h2.865a.522.522 0 0 1 .521.521V3.53a.2.2 0 0 1-.195.199zm-3.31-.4h3.11v-.81a.123.123 0 0 0-.123-.123h-2.868a.123.123 0 0 0-.123.123z" transform="translate(-13.901 6)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
            <path data-name="Path 11542" d="M46.66 33.5h-.018a.2.2 0 0 1-.181-.216l.456-5.2a.2.2 0 1 1 .4.035l-.456 5.2a.2.2 0 0 1-.201.181z" transform="translate(-29.336 -14.745)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
            <path data-name="Path 11543" d="M36.2 33.5a.2.2 0 0 1-.2-.2v-5.2a.2.2 0 0 1 .4 0v5.2a.2.2 0 0 1-.2.2z" transform="translate(-20.958 -14.742)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
            <path data-name="Path 11544" d="M23.9 33.5a.2.2 0 0 1-.2-.182l-.455-5.2a.2.2 0 1 1 .4-.035l.456 5.2a.2.2 0 0 1-.181.216z" transform="translate(-10.747 -14.742)" style="fill: rgb(153, 153, 153); stroke: rgb(153, 153, 153); stroke-width: 0.2px;"></path>
          </svg>
      </button>
      <button class="share-btn" [disabled]="selectedList.itemsCount === 0"
      [class.disabled]="selectedList.itemsCount === 0"
       (click)="shareWishlist(selectedList, $event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="18.25" height="15.969" viewBox="0 0 18.25 15.969">
          <path d="M11.406 0v4.562C2.281 4.562 0 9.239 0 15.968c1.186-4.517 4.562-6.844 9.125-6.844h2.281v4.562l6.844-7.209z" style="fill: rgb(198, 198, 198);"></path>
        </svg>
        Share to
      </button>
    </div>
  </div>
  
  <p class="desc">
    ({{ selectedList.itemsCount }} items) 
    <img src="https://efreshli.com/images/wishlists/public.png" alt="public"> 
    Public
  </p>
  
  <!-- Empty Detail State -->
  <div class="list-content" *ngIf="selectedList.itemsCount === 0">
    <div class="icons">
      <img src="https://efreshli.com/images/wishlists/empty-wishlist-details.png" alt="empty details">
    </div>
    <h2>Your wishlist look empty</h2>
    <p>Start Adding Your Favorite Items, Shops, And Ideas To Your List.</p>
    <button class="build-btn" (click)="goToShopping()">Start Building Your List!</button>
  </div>
  
  <!-- Items Grid -->
  <div class="items-grid" *ngIf="selectedList.itemsCount > 0">
    <div class="item-card" *ngFor="let item of selectedList.wishlistItemsDto">

      <a [routerLink]="['/product-details', item.productId]" class="item-image-link">
      <div class="item-image">
        <img [src]="item.imageUrl || 'assets/placeholder.jpg'" [alt]="item.name">
        
        <!-- Keep heart button outside the link to prevent navigation conflicts -->
        <div class="heart-button-wrapper" (click)="$event.stopPropagation()">
          <app-product-heart-button
              [productId]="item.productId"
              [wishlistId]="selectedList.wishlistId"
              [mode]="'remove'"
              [size]="'small'"
              [initialWishlistStatus]="true"
              [position]="'top-right'"
              (wishlistToggled)="onWishlistToggled($event)"
              class="remove-heart-btn">
          </app-product-heart-button>
        </div>
      </div>
    </a>
      
      <!-- Item Info -->
      <div class="item-info">
        <p class="item-category">{{ item.category || 'Product' }}</p>
        <div class="item-desc">
        <a [routerLink]="['/product-details', item.productId]" class="item-title-link">
          <p class="item-title">{{ item.name || 'Product Name' }}</p>
        </a>          <div class="price-info">
            <span class="final-price">
              {{ item.finalPrice || item.price }} EGP
            </span>
            <span class="original-price" *ngIf="item.discount && item.discount > 0">
              {{ item.price }} EGP
            </span>
            <span class="discount" *ngIf="item.discount && item.discount > 0">
              {{ item.discount }}% off
            </span>
          </div>
        </div>
        <button class="add-to-cart-btn" (click)="addToCart(item)">
          Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Popup -->
<div class="popup-overlay" *ngIf="showCreatePopup">
  <div class="create-popup" (click)="$event.stopPropagation()">
    <h3>Create a list</h3>
    <input [(ngModel)]="newListName" 
           placeholder="Enter list name" 
           class="create-input"
           (keyup.enter)="createList()"
           #createInput>
    <div class="popup-actions">
      <button class="create-btn" 
              (click)="createList()"
              [disabled]="!newListName.trim() || creatingList">
        <i class="fas fa-spinner fa-spin" *ngIf="creatingList"></i>
        <span *ngIf="!creatingList">Create a list</span>
        <span *ngIf="creatingList">Creating...</span>
      </button>
    </div>
    <span class="close" (click)="closeCreatePopup()">&times;</span>
  </div>
</div>
<!-- Add these popups after the existing Create Popup -->

<!-- Edit Wishlist Name Popup -->
<div class="popup-overlay" *ngIf="showEditPopup">
  <div class="create-popup" (click)="$event.stopPropagation()">
    <h3>Edit List Name</h3>
    <input [(ngModel)]="editListName" 
           placeholder="Enter new list name" 
           class="create-input"
           (keyup.enter)="saveListName()"
           (keyup.escape)="cancelEditName()"
           #editInput>
    <div class="popup-actions">
      <button class="create-btn" 
              (click)="saveListName()"
              [disabled]="!editListName.trim() || updatingList">
        <i class="fas fa-spinner fa-spin" *ngIf="updatingList"></i>
        <span *ngIf="!updatingList">Save Changes</span>
        <span *ngIf="updatingList">Saving...</span>
      </button>
    </div>
    <span class="close" (click)="cancelEditName()">&times;</span>
  </div>
</div>

<!-- Delete Confirmation Popup -->
<div class="popup-overlay" *ngIf="showDeleteConfirm">
  <div class="create-popup delete-popup-content" (click)="$event.stopPropagation()">
    <!-- <h3>Delete Wishlist</h3> -->
    <div class="delete-message">
      <p>Are you sure you want to delete "{{ selectedList?.wishlistName }}"?</p>
      <p class="warning-text">Deleting this list is final and cannot be undone.</p>
    </div>
    <div class="popup-actions delete-actions">
      <button class="cancel-popup-btn" 
              (click)="cancelDeleteWishlist()"
              [disabled]="deletingWishlist">
        Cancel
      </button>
      <button class="delete-confirm-btn" 
              (click)="deleteWishlist()"
              [disabled]="deletingWishlist">
        <i class="fas fa-spinner fa-spin" *ngIf="deletingWishlist"></i>
        <span *ngIf="!deletingWishlist">Yes, Sure</span>
        <span *ngIf="deletingWishlist">Deleting...</span>
      </button>
    </div>
    <span class="close" (click)="cancelDeleteWishlist()">&times;</span>
  </div>
</div>